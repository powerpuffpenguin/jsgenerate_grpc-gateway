package register

import (
	"{{pkg}}/logger"
	"{{pkg}}/m/web/contrib/compression"
	"net/http"

	"github.com/gin-gonic/gin"
	"github.com/grpc-ecosystem/grpc-gateway/v2/runtime"
	"github.com/rakyll/statik/fs"
	"go.uber.org/zap"
)

var _compression = compression.Compression(compression.BrDefaultCompression,
	compression.GzDefaultCompression,
)

type queryBind struct {
	AccessToken string `form:"access_token"`
}

func HTTP(engine *gin.Engine, gateway *runtime.ServeMux, swagger bool) {
	engine.NoRoute(func(c *gin.Context) {
		c.Status(http.StatusOK)
		if c.Request.Method == `GET` || c.Request.Method == `HEAD` {
			c.Request.Header.Set(`Method`, c.Request.Method)
		}
		if c.Request.Header.Get(`Authorization`) == `` {
			var query queryBind
			c.ShouldBindQuery(&query)
			if query.AccessToken != `` {
				c.Request.Header.Set(`Authorization`, `Bearer `+query.AccessToken)
			}
		}
		gateway.ServeHTTP(c.Writer, c.Request)
	})
	if swagger {
		document, e := fs.NewWithNamespace(`document`)
		if e != nil {
			logger.Logger.Panic(`statik document error`,
				zap.Error(e),
			)
		}
		r := engine.Group(`document`)
		r.Use(_compression)
		r.StaticFS(``, document)
	}
	// other gin route
}
